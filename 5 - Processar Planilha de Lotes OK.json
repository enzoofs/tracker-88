{
  "name": "5 - Processar Planilha de Lotes OK",
  "nodes": [
    {
      "parameters": {
        "jsCode": "// Processar anexos do email\nconst outputItems = [];\n\nfor (const item of $input.all()) {\n  console.log('=== PROCESSANDO EMAIL ===');\n  console.log('Subject:', item.json.subject);\n  console.log('From:', item.json.from);\n  \n  if (item.binary && Object.keys(item.binary).length > 0) {\n    console.log('Anexos encontrados:', Object.keys(item.binary));\n    \n    for (const [key, attachment] of Object.entries(item.binary)) {\n      const fileName = attachment.fileName || attachment.name || key;\n      const mimeType = attachment.mimeType || attachment.type || '';\n      \n      console.log(`Arquivo: ${fileName}`);\n      console.log(`Tipo: ${mimeType}`);\n      \n      // Aceitar planilhas Excel\n      if (fileName.toLowerCase().includes('.xls') || \n          mimeType.includes('sheet') ||\n          mimeType.includes('excel')) {\n        \n        // Extrair n√∫mero da carga - REGEX MELHORADA\n        const subject = item.json.subject || '';\n        \n        // Tentar v√°rios padr√µes:\n        // 1. \"carga 890\", \"carga-890\", \"carga_890\"\n        // 2. \"lotes 890\", \"lote 890\"\n        // 3. Apenas n√∫meros ap√≥s h√≠fen ou underline: \"- 890\", \"_890\"\n        // 4. Qualquer n√∫mero de 3+ d√≠gitos\n        let numeroCarga = null;\n        \n        const patterns = [\n          /(?:carga|lote|lotes)[:\\s_-]*(\\d+)/i,\n          /[:\\s_-](\\d{3,})/,\n          /(\\d{3,})/\n        ];\n        \n        for (const pattern of patterns) {\n          const match = subject.match(pattern) || fileName.match(pattern);\n          if (match) {\n            numeroCarga = parseInt(match[1]);\n            console.log(`N√∫mero da carga encontrado: ${numeroCarga} (padr√£o: ${pattern})`);\n            break;\n          }\n        }\n        \n        if (!numeroCarga) {\n          console.error('N√∫mero da carga n√£o encontrado');\n          console.error('Subject:', subject);\n          console.error('Filename:', fileName);\n          continue;\n        }\n        \n        outputItems.push({\n          json: {\n            emailFrom: item.json.from || '',\n            emailSubject: item.json.subject || '',\n            emailDate: item.json.receivedDateTime || new Date().toISOString(),\n            fileName: fileName,\n            numero_carga: numeroCarga,\n            emailId: item.json.id || ''\n          },\n          binary: {\n            data: attachment\n          }\n        });\n        \n        console.log(`‚úÖ Planilha adicionada para carga ${numeroCarga}`);\n      }\n    }\n  } else {\n    console.log('AVISO: Nenhum anexo encontrado');\n  }\n}\n\nif (outputItems.length === 0) {\n  throw new Error('Nenhuma planilha de lotes encontrada');\n}\n\nconsole.log(`Total processado: ${outputItems.length}`);\nreturn outputItems;"
      },
      "id": "94787b93-3e1f-4c6a-9146-264c70e1f082",
      "name": "Processar Anexos",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -816,
        16
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "cargas",
        "returnAll": true,
        "filters": {
          "conditions": [
            {
              "keyName": "numero_carga",
              "condition": "eq",
              "keyValue": "={{ $json.numero_carga }}"
            }
          ]
        }
      },
      "id": "34fb5e6b-d673-4b67-9741-d57d89258d16",
      "name": "Verificar Carga Existe",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -592,
        16
      ],
      "alwaysOutputData": true,
      "credentials": {
        "supabaseApi": {
          "id": "oD99Qqe2sNruP4u0",
          "name": "Supabase - tracking@"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Verificar se a carga existe e preparar dados\nconst anexo = $('Processar Anexos').item.json;\nconst cargasEncontradas = $input.all();\n\nconst cargaExiste = cargasEncontradas && \n                    cargasEncontradas.length > 0 && \n                    cargasEncontradas[0].json.numero_carga;\n\nif (!cargaExiste) {\n  console.log(`üì¶ Carga ${anexo.numero_carga} n√£o existe - ser√° criada`);\n  return [{\n    json: {\n      numero_carga: anexo.numero_carga,\n      deve_criar_carga: true,\n      operacao: 'INSERT'\n    },\n    binary: $('Processar Anexos').item.binary\n  }];\n} else {\n  console.log(`‚úÖ Carga ${anexo.numero_carga} j√° existe`);\n  return [{\n    json: {\n      numero_carga: anexo.numero_carga,\n      deve_criar_carga: false,\n      operacao: 'SKIP',\n      carga_id: cargasEncontradas[0].json.id\n    },\n    binary: $('Processar Anexos').item.binary\n  }];\n}"
      },
      "id": "40c3af08-4285-46b8-894a-da81b7049e34",
      "name": "Processar Status Carga",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -368,
        16
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "fileFormat": "xlsx",
        "options": {
          "headerRow": true
        }
      },
      "id": "d9f7287b-b040-49d8-91f5-1c0ed755c304",
      "name": "Ler Planilha Excel",
      "type": "n8n-nodes-base.spreadsheetFile",
      "typeVersion": 2,
      "position": [
        -144,
        16
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Processar dados da planilha de lotes\nconst numeroCarga = $('Processar Status Carga').item.json.numero_carga;\nconst vinculos = [];\nconst sosSet = new Set();\nlet totalItems = 0;\n\nfor (const item of $input.all()) {\n  const row = item.json;\n  \n  // Extrair SO number (pode estar em diferentes campos)\n  const soNumber = (row['SO Number'] || row['Sales Order'] || row['SO'] || row['Order Number'] || '').toString().trim();\n  \n  if (!soNumber) {\n    console.log('Linha sem SO:', row);\n    continue;\n  }\n  \n  sosSet.add(soNumber);\n  totalItems++;\n}\n\n// Criar um item para cada SO √∫nica\nfor (const soNumber of sosSet) {\n  vinculos.push({\n    json: {\n      numero_carga: numeroCarga,\n      so_number: soNumber,\n      item_count: 1, // Ser√° contado depois se necess√°rio\n      status: 'Consolidado',\n      created_at: new Date().toISOString()\n    }\n  });\n}\n\nconsole.log(`=== RESUMO ===`);\nconsole.log(`Carga: ${numeroCarga}`);\nconsole.log(`Total SOs: ${sosSet.size}`);\nconsole.log(`Total Items: ${totalItems}`);\n\n// Adicionar summary no primeiro item\nif (vinculos.length > 0) {\n  vinculos[0].json.summary = {\n    numero_carga: numeroCarga,\n    total_sos: sosSet.size,\n    total_items: totalItems\n  };\n}\n\nreturn vinculos;"
      },
      "id": "fbbea241-1c8b-46fb-a1a8-b318cee26d8f",
      "name": "Processar Dados Planilha",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        80,
        16
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://aldwmdfveivkfxxvfoua.supabase.co/functions/v1/link-sos-to-carga",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Authorization",
              "value": "Bearer p3Rma-STS_n8n_2025"
            },
            {
              "name": "Content-Type",
              "value": "application/json"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "response": {
            "response": {
              "neverError": true
            }
          }
        }
      },
      "id": "628714f9-da8b-4f5a-afbe-2d146c18ea8b",
      "name": "Vincular SO via Lovable",
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        304,
        16
      ],
      "retryOnFail": true
    },
    {
      "parameters": {
        "tableId": "carga_sales_orders",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "numero_carga",
              "fieldValue": "={{ $json.numero_carga }}"
            },
            {
              "fieldId": "so_number",
              "fieldValue": "={{ $json.so_number }}"
            },
            {
              "fieldId": "item_count",
              "fieldValue": "={{ $json.item_count }}"
            },
            {
              "fieldId": "status",
              "fieldValue": "={{ $json.status }}"
            },
            {
              "fieldId": "created_at",
              "fieldValue": "={{ $json.created_at }}"
            }
          ]
        }
      },
      "id": "75b4bc56-f5af-4775-bd4e-4be10808a4fe",
      "name": "Backup Inserir V√≠nculos",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        528,
        16
      ],
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "oD99Qqe2sNruP4u0",
          "name": "Supabase - tracking@"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "operation": "update",
        "tableId": "envios_processados",
        "filters": {
          "conditions": [
            {
              "keyName": "sales_order",
              "condition": "eq",
              "keyValue": "={{ $json.so_number }}"
            }
          ]
        },
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "status_atual",
              "fieldValue": "Consolidado"
            },
            {
              "fieldId": "status_cliente",
              "fieldValue": "Em Importa√ß√£o"
            },
            {
              "fieldId": "ultima_localizacao",
              "fieldValue": "Armaz√©m - Consolidado"
            },
            {
              "fieldId": "data_ultima_atualizacao",
              "fieldValue": "={{ new Date().toISOString() }}"
            }
          ]
        }
      },
      "id": "c84b3ca1-93c7-407a-9db9-c757304a825f",
      "name": "Backup Atualizar SOs",
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        752,
        16
      ],
      "retryOnFail": true,
      "credentials": {
        "supabaseApi": {
          "id": "oD99Qqe2sNruP4u0",
          "name": "Supabase - tracking@"
        }
      },
      "continueOnFail": true
    },
    {
      "parameters": {
        "inputSource": "passthrough"
      },
      "type": "n8n-nodes-base.executeWorkflowTrigger",
      "typeVersion": 1.1,
      "position": [
        -1040,
        16
      ],
      "id": "352a2cf3-a2b2-4732-8eea-99935cf15143",
      "name": "When Executed by Another Workflow",
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Node: Preparar Dados do Log\nconst allItems = $input.all();\n\n// Extrair m√©tricas espec√≠ficas baseado no workflow\nlet workflowMetrics = {};\nlet mainMessage = 'Workflow executado';\n\n// 1 - Standard Daily Order\nif ($workflow.name.includes('Standard Daily Order')) {\n  const salesOrders = allItems.map(i => i.json.sales_order).filter(Boolean);\n  workflowMetrics = {\n    total_orders: salesOrders.length,\n    sales_orders: salesOrders.slice(0, 10), // Primeiras 10 SOs\n    total_value: allItems.reduce((sum, i) => sum + parseFloat(i.json.valor_total || 0), 0).toFixed(2)\n  };\n  mainMessage = `${salesOrders.length} pedidos processados`;\n}\n\n// 2 - Automated Daily Shipment\nelse if ($workflow.name.includes('Automated Daily Shipment')) {\n  workflowMetrics = {\n    total_shipments: allItems.length,\n    tracking_count: allItems.filter(i => i.json.tracking_numbers).length\n  };\n  mainMessage = `${allItems.length} envios processados`;\n}\n\n// 3 - FedEx Scraper\nelse if ($workflow.name.includes('FedEx Scraper')) {\n  workflowMetrics = {\n    trackings_verified: allItems.length,\n    at_warehouse: allItems.filter(i => i.json.is_at_warehouse).length\n  };\n  mainMessage = `${allItems.length} trackings verificados`;\n}\n\n// 4 - Tracking P√≥s-Armaz√©m\nelse if ($workflow.name.includes('Tracking P√≥s-Armaz√©m') || $workflow.name.includes('Tracking P√É¬≥s-Armaz√É¬©m')) {\n  workflowMetrics = {\n    emails_processed: allItems.length,\n    cargas_processadas: allItems.filter(i => i.json.numero_carga).length\n  };\n  mainMessage = `${allItems.length} emails de tracking processados`;\n}\n\n// 5 - Planilha de Lotes\nelse if ($workflow.name.includes('Planilha de Lotes')) {\n  const summary = allItems[0]?.json?.summary || allItems[0]?.json;\n  workflowMetrics = {\n    numero_carga: summary?.numero_carga,\n    total_sos: summary?.total_sos,\n    total_items: summary?.total_items\n  };\n  mainMessage = `Carga ${summary?.numero_carga} processada com ${summary?.total_sos} SOs`;\n}\n\n// 6 - Bio-Rad Pedido\nelse if ($workflow.name.includes('Bio-Rad') && $workflow.name.includes('PEDIDO')) {\n  const orderData = allItems[0]?.json;\n  workflowMetrics = {\n    order_number: orderData?.orderNumber || orderData?.order_number,\n    total_items: orderData?.metrics?.totalItems || orderData?.total_items,\n    total_value: orderData?.financial?.total || orderData?.total_value\n  };\n  mainMessage = `Pedido ${orderData?.orderNumber} registrado`;\n}\n\n// 7 - Bio-Rad Confirma√ß√£o\nelse if ($workflow.name.includes('Bio-Rad') && $workflow.name.includes('CONFIRMA√á√ÉO')) {\n  const orderData = allItems[0]?.json;\n  workflowMetrics = {\n    order_number: orderData?.orderNumber,\n    confirmation_number: orderData?.confirmationNumber,\n    status: orderData?.overallStatus,\n    confirmed_items: orderData?.metrics?.confirmedItems,\n    total_items: orderData?.metrics?.totalItems\n  };\n  mainMessage = `Confirma√ß√£o ${orderData?.confirmationNumber} processada`;\n}\n\n// Fallback gen√©rico\nelse {\n  workflowMetrics = {\n    items_count: allItems.length\n  };\n  mainMessage = `${allItems.length} items processados`;\n}\n\n// Retornar dados formatados\nreturn [{\n  json: {\n    workflow_name: $workflow.name,\n    workflow_id: $workflow.id,\n    execution_id: $execution.id,\n    level: 'info',\n    message: mainMessage,\n    data: workflowMetrics,\n    performance: {\n      duration_ms: null,\n      items_processed: allItems.length\n    },\n    context: {\n      execution_mode: $execution.mode,\n      timestamp: new Date().toISOString()\n    }\n  }\n}];"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        1200,
        16
      ],
      "id": "3653780d-4e14-4ad3-836f-6794242a7c16",
      "name": "Preparar Dados do Log",
      "retryOnFail": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://sintesebio.app.n8n.cloud/webhook/logger",
        "sendHeaders": true,
        "headerParameters": {
          "parameters": [
            {
              "name": "Content-Type",
              "value": "application/json"
            },
            {
              "name": "x-api-key",
              "value": "p3Rma-STS_n8n_2025"
            }
          ]
        },
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={{ JSON.stringify($json) }}",
        "options": {
          "timeout": 5000
        }
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        1424,
        16
      ],
      "id": "31ea886d-c047-4935-96f3-820942184a0d",
      "name": "HTTP Request1",
      "retryOnFail": true
    },
    {
      "parameters": {
        "jsCode": "// Combinar resultados e gerar resumo\nconst allResults = $input.all();\nconst summary = allResults[0]?.json?.summary;\n\nif (!summary) {\n  return [{\n    json: {\n      status: 'completed',\n      message: 'Processamento conclu√≠do',\n      timestamp: new Date().toISOString()\n    }\n  }];\n}\n\nreturn [{\n  json: {\n    status: 'success',\n    numero_carga: summary.numero_carga,\n    total_sos: summary.total_sos,\n    total_items: summary.total_items,\n    sos_processadas: allResults.length,\n    timestamp: new Date().toISOString(),\n    message: `Carga ${summary.numero_carga}: ${summary.total_sos} SOs vinculadas`\n  }\n}];"
      },
      "id": "b9e369e3-26e4-4f0c-85d9-84fb131a0851",
      "name": "Gerar Resumo",
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        976,
        16
      ],
      "retryOnFail": true
    }
  ],
  "pinData": {
    "When Executed by Another Workflow": [
      {
        "json": {
          "workflow_destino": "planilha_lotes",
          "workflow_id": "G9ToKNnnyM4SPv3Q",
          "tipo_email": "planilha_lotes",
          "email": {
            "id": "AAMkAGE4ZWUwNzk4LWI2NDYtNGQwOS1hMjk0LTk0MTBiOTRiYWJlYQBGAAAAAACJJbUa19cwTJ-q5cKIhmGZBwB5_z_ylZG-R54aMqDFRhSeAAAAAAEMAAB5_z_ylZG-R54aMqDFRhSeAAA7-LaRAAA=",
            "conversationId": "AAQkAGE4ZWUwNzk4LWI2NDYtNGQwOS1hMjk0LTk0MTBiOTRiYWJlYQAQAJN2tKA98tNKuq6kUul6JSw=",
            "internetMessageId": "<CPYP284MB1288DDD97CA36B063E0A284B82FCA@CPYP284MB1288.BRAP284.PROD.OUTLOOK.COM>",
            "subject": "Planilha Lotes - CARGA 895 - IDT - AM",
            "bodyPreview": "Boa tarde!\r\n\r\nSegue planilha de lotes da carga 895.\r\nFico √† disposi√ß√£o",
            "body": {
              "contentType": "html",
              "content": "<html>\r\n<head>\r\n<meta http-equiv=\"Content-Type\" content=\"text/html; charset=utf-8\">\r\n<meta name=\"Generator\" content=\"Microsoft Exchange Server\">\r\n<!-- converted from rtf -->\r\n<style><!-- .EmailQuote { margin-left: 1pt; padding-left: 4pt; border-left: #800000 2px solid; } --></style>\r\n</head>\r\n<body>\r\n<font face=\"Calibri\" size=\"3\"><span style=\"font-size:12pt;\">\r\n<div>Boa tarde!</div>\r\n<div>&nbsp;</div>\r\n<div>Segue planilha de lotes da carga 895.</div>\r\n<div>Fico √† disposi√ß√£o</div>\r\n<div>&nbsp;</div>\r\n<div><font face=\"Aptos\"><a href=\"cid:2AF6FD134E85327CA83F9A066606DBC8D29E581F@1\">Planilha Lotes - 895.xlsx</a> </font></div>\r\n<div><font face=\"Aptos\">&nbsp;</font></div>\r\n</span></font>\r\n</body>\r\n</html>\r\n"
            },
            "from": {
              "address": "enzo@sintesebio.com.br",
              "name": "Enzo Ferraz | Sintese Biotecnologia"
            },
            "to": [
              {
                "emailAddress": {
                  "name": "tracking",
                  "address": "tracking@sintesebio.com.br"
                }
              }
            ],
            "cc": [],
            "receivedAt": "2025-10-27T18:24:56Z",
            "headers": null,
            "hasAttachments": true,
            "attachmentsMeta": [
              {
                "key": "attachment_0",
                "fileName": "Planilha Lotes - 895.xlsx",
                "mimeType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
                "fileSize": "12.6 kB"
              }
            ]
          },
          "email_norm": {
            "subject_lc": "planilha lotes - carga 895 - idt - am",
            "body_preview_lc": "boa tarde!\r\n\r\nsegue planilha de lotes da carga 895.\r\nfico √† disposi√ß√£o",
            "from_lc": "enzo@sintesebio.com.br",
            "from_name_lc": "enzo ferraz | sintese biotecnologia",
            "attachment_names_lc": "planilha lotes - 895.xlsx"
          }
        },
        "binary": {
          "attachment_0": {
            "mimeType": "application/vnd.openxmlformats-officedocument.spreadsheetml.sheet",
            "fileExtension": "xlsx",
            "data": "filesystem-v2",
            "fileName": "Planilha Lotes - 895.xlsx",
            "id": "filesystem-v2:workflows/d4ed9vH6sErTkEZN/executions/temp/binary_data/aff20621-3379-41fb-aac0-627e6c8762a1",
            "fileSize": "12.6 kB"
          }
        }
      }
    ]
  },
  "connections": {
    "Processar Anexos": {
      "main": [
        [
          {
            "node": "Verificar Carga Existe",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Verificar Carga Existe": {
      "main": [
        [
          {
            "node": "Processar Status Carga",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Status Carga": {
      "main": [
        [
          {
            "node": "Ler Planilha Excel",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Ler Planilha Excel": {
      "main": [
        [
          {
            "node": "Processar Dados Planilha",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Processar Dados Planilha": {
      "main": [
        [
          {
            "node": "Vincular SO via Lovable",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Vincular SO via Lovable": {
      "main": [
        [
          {
            "node": "Backup Inserir V√≠nculos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Backup Inserir V√≠nculos": {
      "main": [
        [
          {
            "node": "Backup Atualizar SOs",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Backup Atualizar SOs": {
      "main": [
        [
          {
            "node": "Gerar Resumo",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "When Executed by Another Workflow": {
      "main": [
        [
          {
            "node": "Processar Anexos",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Preparar Dados do Log": {
      "main": [
        [
          {
            "node": "HTTP Request1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Gerar Resumo": {
      "main": [
        [
          {
            "node": "Preparar Dados do Log",
            "type": "main",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1",
    "callerPolicy": "workflowsFromSameOwner",
    "errorWorkflow": "vpEAvi7gkAjmLvkl"
  },
  "versionId": "a57026b6-a68f-4b3b-a926-3267440c1703",
  "meta": {
    "instanceId": "dcba349999e42800a73e5235199b71095d4545b83e3b6d9b2806516e371d0786"
  },
  "id": "G9ToKNnnyM4SPv3Q",
  "tags": []
}